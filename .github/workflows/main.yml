name: Linkbox API Deployment

on:
    push:
        branches:
            - 'main'

jobs:
    SSH_DEPLOY:
        runs-on: [self-hosted, linkbox-api-runner]

        steps:
            - name: Execute Deployment Script
              uses: appleboy/ssh-action@master
              with:
                  key: ${{ secrets.KEY }}
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  script: |
                      set -e  # ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œ

                      APP_DIR="/home/${{ secrets.USERNAME }}/linkbox-api"
                      PROD_DIR="$APP_DIR/production"

                      # nvm
                      source /home/${{ secrets.USERNAME }}/.nvm/nvm.sh                      

                      # env ìƒì„±
                      echo "ğŸ”‘ Creating .env file in $PROD_DIR..."
                      echo "${{ secrets.ENV }}" > $PROD_DIR/.env.production
                      chmod 600 $PROD_DIR/.env.production

                      # ë¹Œë“œ
                      echo "ğŸ› ï¸ Fetching the latest code in $PROD_DIR..."
                      cd $PROD_DIR
                      git fetch origin main
                      git reset --hard origin/main

                      echo "ğŸ› ï¸ Installing dependencies in $PROD_DIR..."
                      yarn install --prefer-offline --check-files --frozen-lockfile

                      echo "ğŸ› ï¸ Building the application in $PROD_DIR..."
                      yarn build
                      if [ ! -d "$PROD_DIR/dist" ]; then
                          echo "âŒ Build failed: dist directory not found!"
                          exit 1
                      fi

                      # PM2 ì¬ì‹œì‘
                      echo "ğŸš€ Reloading PM2 with the new build..."
                      if pm2 list | grep -q linkbox-api; then
                          pm2 reload $PROD_DIR/ecosystem.config.js --update-env
                          echo "âœ… Application successfully reloaded."
                      else
                          pm2 start $PROD_DIR/ecosystem.config.js
                          echo "âœ… Application successfully started."
                      fi

                      echo "ğŸ‰ Deployment completed successfully!"
